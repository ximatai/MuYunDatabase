# 迁移反馈需求池（待评估）

本文档记录“存量项目迁移到 MuYunDatabase 3.x 主路径”过程中沉淀的功能/API 升级需求。
本文档仅是候选池，不等同于发布承诺或稳定契约。

## 使用方式（给维护者）

1. 新需求先记录在本文档，状态默认 `待评估`。
2. 评估通过后，迁移到 `docs/ROADMAP.md` 的具体优先级（P0/P1/P2）。
3. 实施完成后，在本文档标记为 `已完成`，并附对应 PR/版本号。

## 状态与优先级说明

1. 状态：`待评估` | `已排期` | `进行中` | `已完成` | `已拒绝`。
2. P0：影响正确性/性能基线/跨库一致性，且改动面可控。
3. P1：主要提升开发体验和迁移效率。
4. P2：指南化与边界澄清，降低长期维护成本。

## 非目标

1. 不在此文档定义关系型 ORM（`1:N/N:N`、级联、延迟加载）能力。
2. 不在此文档承诺破坏性 API 变更。
3. 不在此文档记录具体业务项目细节。

## 需求清单

### [P0][待评估] 1. `EntityDao.count` 走直接计数路径

- 问题：仓库代理层 `count(criteria)` 当前通过 `pageQuery(...).getTotal()` 间接实现。
- 目标：代理分发直接走计数 SQL 路径，避免额外分页查询链路。
- 影响面：
1. `muyun-database-spring-boot-starter` 仓库方法分发逻辑。
2. `count` 相关双库回归与性能基线。
- 验收：
1. `count` 不触发 `SELECT *`。
2. MySQL/PostgreSQL 返回一致。
3. 对外方法签名与语义保持兼容。

### [P0][待评估] 2. `existsById` 提供高效存在性判定

- 问题：当前仓库代理使用 `findById != null` 推导存在性。
- 目标：新增专用存在性 SQL 路径（例如 `SELECT 1 ... LIMIT 1`）。
- 影响面：
1. `EntityDao.existsById` 分发逻辑。
2. 主键类型兼容（STRING/LONG/INTEGER/UUID）。
- 验收：
1. `existsById` 不依赖实体映射。
2. 返回语义与当前一致。
3. MySQL/PostgreSQL 一致。

### [P1][待评估] 3. Jdbi SQL 注解的安全与用法约束强化

- 问题：`@Bind/@BindList/@Define` 混用时，迁移阶段常出现 `@Define` 误用导致拼接风险。
- 目标：强化文档与校验口径，明确 `@Define` 仅用于受控标识符（如 schema/table 常量）。
- 影响面：
1. `README/QUICKSTART/API_CONTRACT` 示例与规则说明。
2. 启动校验或运行期告警策略（需评估兼容性）。
- 验收：
1. 三份主文档口径一致。
2. 至少覆盖 1 组“安全写法 vs 危险写法”示例。
3. 对危险模式提供 fail-fast 或明确告警策略（择一）。

### [P1][待评估] 4. Repository 分页/查询样板补齐

- 问题：常见“列表 + 总数 + 条件拼装”场景可复制样板不足。
- 目标：补齐可编译、可运行、可照抄的标准样板。
- 影响面：
1. `samples` 与 `docs/QUICKSTART.md`。
2. `docs/REFACTOR_GUIDE.md` 的迁移片段。
- 验收：
1. sample 可编译运行。
2. 文档示例与 sample 完全一致。
3. 至少覆盖 `query/pageQuery/count` 与 Jdbi SQL 注解混用。

### [P2][待评估] 5. Map/实体混用迁移指南

- 问题：存量系统大量使用 `Map<String, Object>`，无法一次性实体化。
- 目标：给出分阶段迁移策略与推荐边界。
- 影响面：
1. `docs/REFACTOR_GUIDE.md`。
2. 用法示例测试或 sample。
- 验收：
1. 提供阶段化迁移步骤（最少 3 阶段）。
2. 提供至少 1 组可直接复用的使用样例。

### [P2][待评估] 6. 复杂动态 SQL 场景边界模板

- 问题：复杂动态查询场景仍需保留底层能力，边界易模糊。
- 目标：明确“仓库层 vs 底层 SQL”决策准则与事务边界建议。
- 影响面：
1. `docs/REFACTOR_GUIDE.md`。
2. `docs/API_CONTRACT.md` 的边界声明（如需）。
- 验收：
1. 给出边界决策清单（适合 Repository / 适合底层 SQL）。
2. 至少提供 1 组复杂场景示例。

## 变更记录

1. 初始版本：迁移实战反馈归档（待评估池）。
